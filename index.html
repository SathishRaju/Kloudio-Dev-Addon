<!DOCTYPE html>
<html>

<head>
    <title>Kloudio Google sheets addon</title>
    <?!=include( 'Stylesheet'); ?>
        <style>
            .uk-accordion-title {
                font-size: 14px;
            }
            .sidebar {
                -moz-box-sizing: border-box;
                box-sizing: border-box;
                overflow-y: auto;
                position: absolute;
                width: 100%;
            }
            .branding-below {
                bottom: 40px;
                top: 0;
            }
            .bottom,
            .bottom-left,
            .button-bar {
                bottom: 0;
                position: absolute;
                border-top: 1px solid #efefef;
                background: #fff;
            }
            .logo {
                width: 150px;
                height: 53px;
            }
            .no-spin::-webkit-inner-spin-button {
  -webkit-appearance: none;
}
am-multiselect .dropdown-menu{
    padding-left: 5px;
    padding-right: 5px;
}

am-multiselect .dropdown-menu > li > a {
    padding: 3px 10px;
    cursor:pointer;
}

am-multiselect .dropdown-menu > li.selected {
    background-color: #ADD8E6;
}

        </style>
     <link rel="stylesheet"  href="https://s3-us-west-1.amazonaws.com/kloudioforgoogle/angular-datepicker.min.css">
</head>

<body ng-app="app">
    <div class="app-loading">
        <p align="center">
            <img src="https://s3-us-west-1.amazonaws.com/kloudioforgoogle/rotate.gif">
        </p>
    </div>
    <div class="app-wrapper sidebar branding-below" style="display:none;">
        <div ng-controller="ReportsCtrl">
           <? if(trialText !== '') { ?>
              <div class="<?= bgColor ?>" uk-alert ng-if="!isLoading">
                  <p align="center"><?=trialText ?></p>
                  <p align="center"><a href="<?=upgradeUrl ?>" target="_blank" class="uk-button uk-button-small uk-button-primary"><?=upgradeText?></a></p>
              </div>
          <? } ?>
        <ul uk-tab  style="background:#fff;">
           <li ng-class="reportsTabActive ? 'uk-active' : ''"><a href="">My Reports</a>
           </li>
            <li ng-class="reportsTabActive ? '' : 'uk-active'" ng-if="currentUser && currentUser.planName !=='Starter' && showSchedule"><a href="">Schedule</a>
            </li>
        </ul>
             
            <ul class="uk-switcher uk-margin">
                <li ng-class="reportsTabActive ? 'uk-active' : ''">
                        <p align="center" ng-if="isLoading">
                           <img src="https://s3-us-west-1.amazonaws.com/kloudioforgoogle/rotate.gif">
                        </p>
                    <form class="uk-form-small" ng-if="!isLoading">
                        <fieldset class="uk-fieldset">
                            <div style="background: #efefef;padding:10px 5px;vertical-align: middle;margin-bottom: 10px;">
                                <h5 style="padding:0;vertical-align: middle;margin:0"><strong>STEP 1:</strong> <span style="font-weight:300">Select a Report</span></h5>
                            </div>
                            <div class="uk-container">
                                <div class="field">
                                    <select ng-model="selectedQuery.query" class="uk-select uk-form-small" ng-change="selectedQueryChanged()">
                                        <option ng-value="query.value" ng-repeat="query in myQueries">{{query.display}}</option>
                                    </select>
                                    <!--<button class="uk-button uk-button-default uk-button-small">Refresh</button> -->
                                </div>
                            </div>
                            <div class="uk-margin" style="background: #efefef;padding:10px 5px;vertical-align: middle;margin-bottom: 10px;">
                                <h5 style="padding:0;vertical-align: middle;margin:0"><strong>STEP 2:</strong> <span style="font-weight:300">Filters</span></h5>
                            </div>
                            <div class="uk-margin uk-container" ng-if="selectedQuery.query && selectedQuery.query.queryParams && selectedQuery.query.queryParams.length >0">
                                <ul uk-accordion="multiple: true">
                                    <li ng-repeat="p in selectedQuery.query.queryParams">
                                        <h4 class="uk-accordion-title">{{p.paramDisplayName}}</h4>
                                       <!-- <span ng-if="p.operator !== 'between'" class="float-right">
                                           {{paramValues[p.paramName]}}
                                        </span>
                                        <span ng-if="p.operator == 'between'" class="float-right">
                                           {{paramValues[p.paramName + '-from']}} - {{paramValues[p.paramName + '-to']}}
                                        </span> -->                                 
                                         
                                        <div class="uk-accordion-content">
                                            <div ng-if="p.operator !== 'between'">
                                                <input type="text" ng-model="paramValues[p.paramName]" class="uk-input uk-form-small" ng-if="p.paramType === 'Text' || p.paramType ==='CSV'" ng-required="p.paramRequired">
                                                <!--<input type="date" ng-model="paramValues[p.paramName]" class=" no-spinuk-input uk-form-small" ng-if="p.paramType === 'Date'" ng-required="p.paramRequired"> -->
                                                <datepicker ng-if="p.paramType === 'Date'" date-format="{{p.format ? p.format.replace('mm', 'MM') : 'yyyy-MM-dd'}}">
                                                   <input ng-model="paramValues[p.paramName]" type="text" ng-required="p.paramRequired" class=" no-spinuk-input uk-form-small" />
                                                </datepicker>
                                                <select ng-model="paramValues[p.paramName]" class="uk-select uk-form-small" ng-if="p.paramType === 'Select'" ng-required="p.paramRequired">
                                                    <option ng-repeat="row in selectData[p.paramName]" ng-value="row.value.trim()">
                                                        {{row.display}}
                                                    </option>
                                                </select>
                                                <am-multiselect class="uk-form-small" multiple="true" ms-selected ="{{paramValues[p.paramName].length}} selected"
                                                ng-model="paramValues[p.paramName]" ms-header="Select"
                                                options="c.display for c in selectData[p.paramName]"
                                                change="selected()"></am-multiselect>                                                
                                                 <!--<multiselect  multiple="true"
                                                 ng-model="paramValues[p.paramName]"
                                                 options="c.display for c in selectData[p.paramName]"
                                                 change="selected()" >
                                                </multiselect> -->
                                            </div>
                                            <div ng-if="p.operator == 'between'">
                                                <label class="uk-form-label">From:</label>
                                                <input type="text" ng-model="paramValues[p.paramName + '-from']" class="uk-input uk-form-small" ng-if="p.paramType === 'Text'" ng-required="p.paramRequired">
                                                <!--<input type="date" ng-model="paramValues[p.paramName + '-to']" class="no-spin uk-input uk-form-small" ng-if="p.paramType === 'Date'" ng-required="p.paramRequired"> -->
                                                <datepicker ng-if="p.paramType === 'Date'"  date-format="{{p.format ? p.format.replace('mm', 'MM') : 'yyyy-MM-dd'}}">
                                                   <input ng-model="paramValues[p.paramName + '-from']" type="text" ng-required="p.paramRequired" class=" no-spinuk-input uk-form-small" />
                                                </datepicker>                                              
                                                <select ng-model="paramValues[p.paramName + '-from']" class="uk-select uk-form-small" ng-if="p.paramType === 'Select'" ng-required="p.paramRequired">
                                                    <option ng-repeat="row in selectData[p.paramName]" ng-value="row.value.trim()">
                                                        {{row.display}}
                                                    </option>
                                                </select>
                              
                                                <label class="uk-form-label">To:</label>
                                                <input type="text" ng-model="paramValues[p.paramName + '-to']" class="uk-input uk-form-small" ng-if="p.paramType === 'Text'" ng-required="p.paramRequired">
                                                <!--<input type="date" ng-model="paramValues[p.paramName + '-from']" class="no-spin uk-input uk-form-small" ng-if="p.paramType === 'Date'" ng-required="p.paramRequired"> -->
                                                <datepicker ng-if="p.paramType === 'Date'"  date-format="{{p.format ? p.format.replace('mm', 'MM') : 'yyyy-MM-dd'}}">
                                                   <input ng-model="paramValues[p.paramName + '-to']" type="text" ng-required="p.paramRequired" class=" no-spinuk-input uk-form-small" />
                                                </datepicker>                                                  
                                                <select ng-model="paramValues[p.paramName + '-to']" class="uk-select uk-form-small" ng-if="p.paramType === 'Select'" ng-required="p.paramRequired">
                                                    <option ng-repeat="row in selectData[p.paramName]" ng-value="row.value.trim()">
                                                        {{row.display}}
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="uk-alert uk-margin uk-container" ng-if="selectedQuery.query && (!!!selectedQuery.query.queryParams || selectedQuery.query.queryParams.length == 0)">
                                No Filters defined for this report.
                            </div>
                            <div class="uk-margin uk-container">
                                <button class="uk-button uk-button-primary" ng-click="fetchData()" ng-disabled="!!!selectedQuery.query || queryRunning">
                                    <div ng-if="queryRunning" uk-spinner></div>{{queryRunning? ' Please wait' : 'Run Report'}}
                                </button>
                            </div>
                            <div class="uk-margin uk-container">
                                <button class="uk-button uk-button-secondary" ng-click="insertAsFormula()">
                                    Insert As Formula
                                </button>
                            </div>                            
                            <div ng-if="myQueries && myQueries.length ==0" class="uk-alert-info">
                              You have not created any reports in Kloudio yet. <a href="<?=appUrl ?>" target="_blank" >Click here </a> to create reports.
                            </div>
                        </fieldset>
                    </form>
                </li>
                <li ng-class="reportsTabActive ? '' : 'uk-active'" ng-if="currentUser && currentUser.planName !=='Starter' && showSchedule">
                    <div style="background: #efefef;padding:10px 5px;vertical-align: middle;margin-bottom: 10px;">
                        <h5 style="padding:0;vertical-align: middle;margin:0"><strong>STEP 3:</strong> <span style="font-weight:300">Setup Auto Refresh(Optional)</span></h5>
                    </div>
                    <div class="uk-container">
                        <div ng-if="currentUser && !!!currentUser.googleAuthCode" class="uk-alert-danger">
                          <p align="left">Offline access to Google sheets has to be enabled in order to schedule auto refresh. Please enable Offline Access in your Kloudio Account Settings.
                          <a href="<?=appUrl ?>/#/app/account" target="_blank">Setup Offline Access</a></p>
                        </div> 
                        <form class="uk-form-stacked" ng-if="currentUser && currentUser.googleAuthCode">
                            <div class="uk-margin">
                                <label class="uk-form-label">Select Frequency</label>
                                <div class="uk-form-controls">
                                    <select class="uk-select uk-form-small" id="frequency_select" ng-model="schedule.frequency" ng-change="scheduleChanged($event)" ng-disabled="!schedule.enabled">
                                        <option ng-repeat="fval in ['Minute','Hourly','Daily', 'Weekly', 'Monthly']" value="{{fval}}">{{fval}}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="uk-margin" ng-if="schedule.frequency == 'Hourly'">
                                <label class="uk-form-label">Select Minute</label>
                                <div class="uk-form-controls">
                                    <select class="uk-select uk-form-small" id="hourly_min" ng-model="schedule.minute" ng-disabled="!schedule.enabled">
                                        <option ng-repeat="min in ['00','15','30','45']" value="{{min}}">{{min}}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="uk-margin" ng-if="schedule.frequency == 'Minute'">
                                <label class="uk-form-label">Select Interval</label>
                                <div class="uk-form-controls">
                                    <select class="uk-select uk-form-small" id="min_interval" ng-model="schedule.minute" ng-disabled="!schedule.enabled">
                                        <option ng-repeat="min in ['5','15','30','45']" value="{{min}}">{{min}}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="uk-margin" ng-if="schedule.frequency == 'Weekly'">
                                <label class="uk-form-label">Select Day</label>
                                <div class="uk-form-controls">
                                    <select class="uk-select uk-form-small" id="day_of_week" ng-model="schedule.day" ng-disabled="!schedule.enabled">
                                        <option ng-repeat="dow in [{name:'Sun',indx: 0},{name:'Mon', indx:1},{name:'Tue',indx:2},{name:'Wed',indx:3},{name:'Thu',indx:4},{name:'Fri',indx:5},{name:'Sat',indx:6}]" value="{{dow.indx}}">{{dow.name}}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="uk-margin" ng-if="schedule.frequency == 'Monthly'">
                                <div class="uk-form-label">Select Date</div>
                                <div class="uk-form-controls">
                                    <select class="uk-select uk-form-small" id="day_of_month" style="" ng-model="schedule.day" ng-disabled="!schedule.enabled">
                                        <option ng-repeat="dom in [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30]" value="{{dom}}">{{dom}}</option>
                                    </select>
                                </div>
                            </div>

                            <label class="uk-form-label" ng-if="schedule.frequency == 'Daily' || schedule.frequency == 'Weekly' || schedule.frequency == 'Monthly'">Select Time</label>
                            <div class="uk-margin uk-grid-small" ng-if="schedule.frequency == 'Daily' || schedule.frequency == 'Weekly' || schedule.frequency == 'Monthly'" uk-grid>

                                <div class="" style="display:inline-block;width:70px;">
                                    <select class="uk-select uk-form-small" id="hval_select" style="" ng-model="schedule.hour" ng-disabled="!schedule.enabled" placeholder="Hour">
                                        <option ng-repeat="hval in [1,2,3,4,5,6,7,8,9,10,11,12]" value="{{hval}}">{{hval}}</option>
                                    </select>
                                </div>

                                <div style="display:inline-block;width:70px;">
                                    <select class="uk-select uk-form-small" id="mval_select" style="" ng-model="schedule.minute" ng-disabled="!schedule.enabled" placeholder="Min">
                                        <option ng-repeat="mval in ['00','15','30','45']" value="{{mval}}">{{mval}}</option>
                                    </select>
                                </div>

                                <div style="display:inline-block;width:70px;">
                                    <select class="uk-select uk-form-small ampm uk-form-width-small" id="am_pm_select" style="" ng-model="schedule.am_pm" ng-disabled="!schedule.enabled" placeholder="Am/Pm">
                                        <option ng-repeat="p in ['AM','PM']" value="{{p}}">{{p}}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="uk-margin" ng-if="schedule.frequency == 'Daily' || schedule.frequency == 'Weekly' || schedule.frequency == 'Monthly'">
                                <div class="uk-form-label">Select Timezone</div>
                                <div class="uk-form-controls">
                                    <select class="uk-select uk-form-small" id="tz_select" style="" ng-model="schedule.timezone" ng-disabled="!schedule.enabled">
                                        <option ng-repeat="tz in timezones" value="{{tz.name}}">{{tz.desc}}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="uk-margin uk-form-controls">
                                <label class="uk-form-label">
                                    <input type="checkbox" class="uk-checkbox" ng-model="schedule.email_on_success" ng-true-value="true" ng-false-value="false">&nbsp;Email when sheet is refreshed</label>
                            </div>
                            <div class="uk-margin">
                                <button class="uk-button uk-button-primary" id="updateSchBtn" ng-click="updateSchedule();" ng-disabled="schRunning">
                                    <div ng-if="schRunning" uk-spinner></div>{{schRunning ? ' Please wait...' : 'Save'}}
                                </button>
                                <button class="uk-button" onClick="google.script.host.close();">Cancel</button>
                                <div class="uk-alert-danger" uk-alert ng-if="errors !==''">
                                     <p>{{errors}}</p>
                                </div>                                  
                            </div>
                        </form>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <div class="sidebar bottom">
        <p align="center" style="margin:0;padding:0">
            <img class="logo" src="https://s3.amazonaws.com/kloudioassets/images/kloudioleft.png">
        </p>    
    </div>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
   <!-- UIkit JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.17/js/uikit.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.17/js/uikit-icons.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.2/angular.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.js"></script>
    <?!=include( 'Javascript'); ?>
    <script src="https://s3-us-west-1.amazonaws.com/kloudioforgoogle/angular-datepicker.min.js"></script>

        <script>
            $(document).ready(function() {
                $('.app-wrapper').fadeIn(1000);
                $('.app-loading').css('display', 'none');
            });
        </script>

</body>

</html>